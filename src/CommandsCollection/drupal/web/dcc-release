#!/bin/bash

############################
# DDEV Commands Collection #
############################

## https://github.com/jackd248/ddev-commands-collection
## v<version/>
## dcc-autogenerated
. "$(dirname "$0")/../scripts/dcc-colors.sh"
. "$(dirname "$0")/../dcc-config.sh"
printf "${reset}${cyan}[DCC]${reset} DDEV Commands Collection\n"

## Description: Create a new app version
## Usage: release
## Example: "ddev release 4.5.0" or "ddev release 1.2.0-RC"
version=$@

# Check if given version correspond to the semver guidelines
if [[ $version =~ ^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-((0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*)(\.(0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*))*))?(\+([0-9a-zA-Z-]+(\.[0-9a-zA-Z-]+)*))?$ ]]; then
  echo -e "${blue}[Info]${reset} Adjust composer.json and generate composer.lock"

  # Find the line number of the version entry in the composer.json file
  lineNumber=$(sed -n '/version/=' $composerPathApp/composer.json)

  # Update property "version"
  printf "${reset}${cyan}[DCC]${reset}${reset}<web> ${black}composer config version $version -d $composerPathApp${reset}\n"
  composer config version $version -d $composerPathApp

  # Generate new composer.lock file to keep the composer files valid
  printf "${reset}${cyan}[DCC]${reset}${reset}<web> ${black}composer update nothing -d "$composerPathApp" -q --no-scripts${reset}\n"
  composer update nothing -d "$composerPathApp" -q --no-scripts

  # Validate composer files
  printf "${reset}${cyan}[DCC]${reset}${reset}<web> ${black}composer validate -d "$composerPathApp"${reset}\n"
  composer validate -d "$composerPathApp"

  # Distinguish between Release Candidate and Release
  if [[ $version == *"RC"* ]]; then
    note="Build"
  else
    note="Release"
  fi
  # Print possible git commit message
  echo -e "${green}[$note]${reset} Version $version"
else
  echo -e "${red}[Failure]${reset} Given version '$version' not matching semantic version constraints"
fi