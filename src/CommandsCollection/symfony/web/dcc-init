#!/bin/bash

############################
# DDEV Commands Collection #
############################

## https://github.com/jackd248/ddev-commands-collection
## v<version/>
## dcc-autogenerated
. "$(dirname "$0")/../dcc-config.sh"
. "$(dirname "$0")/../scripts/dcc-colors.sh"
printf "${reset}${cyan}[DCC]${reset} DDEV Commands Collection\n"

## Description: Install and initialize local Symfony instance
## Usage: init
## Example: "ddev init"

echo
read -p $'${magenta}[CONFIG]${reset} Initialize Symfony instanz? (y/n)[n] ' INIT_SYMFONY
read -p $'${magenta}[CONFIG]${reset} Sync database (stage-to-local)? (y/n)[n] ' SYNC_DB
read -p $'${magenta}[CONFIG]${reset} Sync files (stage-to-local)? (y/n)[n] ' SYNC_FILES
read -p $'${magenta}[CONFIG]${reset} Build assets? (y/n)[n] ' INSTALL_ASSETS

if [[ $INIT_SYMFONY =~ ^[Yy]$ ]]
then
    echo -e "${blue}[INFO]${reset} Install Symfony"
    cd ${composerPathApp}
    printf "DATABASE_URL=mysql://db:db@db:3306/db\nMAILER_URL=smtp://localhost:1025\nSYMFONY_ENVIRONMENT=Development" >> ${composerPathApp}/.env.local
    composer install
    php bin/console doctrine:migrations:migrate -n
    php bin/console doctrine:fixtures:load -n
    echo -e "${green}[OK]${reset} Symfony installed"
fi

if [[ $SYNC_DB =~ ^[Yy]$ ]]
then
    echo -e "${blue}[INFO]${reset} Sync remote database into local database"
    db_sync_tool -f /var/www/html/deployment/db-sync-tool/sync-${defaultSyncSystem}-to-local.json -o /var/www/html/deployment/db-sync-tool/hosts.json
fi

if [[ $SYNC_FILES =~ ^[Yy]$ ]]
then
    echo -e "${blue}[INFO]${reset} Sync remote files into local filesystem"
    file_sync_tool -f /var/www/html/deployment/db-sync-tool/sync-${defaultSyncSystem}-to-local.json -o /var/www/html/deployment/db-sync-tool/hosts.json
fi

if [[ $SYNC_DB =~ ^[Yy]$ ]] || [[ $SYNC_FILES =~ ^[Yy]$ ]]
then
    # display faq section
    sh "$(dirname "$0")/../faq/dcc-faq-web-sync.sh"
fi


if [[ $INSTALL_ASSETS =~ ^[Yy]$ ]]
then
    echo -e "${blue}[INFO]${reset} Install assets"
    cd ${composerPathApp}
    npm ci
    npm run build
    echo -e "${green}[OK]${reset} Assets installed"
fi
echo
echo -e "${green}Done.${reset}"
