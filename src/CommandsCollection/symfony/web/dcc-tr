#!/bin/bash

############################
# DDEV Commands Collection #
############################

## https://github.com/jackd248/ddev-commands-collection
## v<version/>
## dcc-autogenerated
. "$(dirname "$0")/../dcc-config.sh"
. "$(dirname "$0")/../scripts/dcc-colors.sh"
printf "${reset}${cyan}[DCC]${reset} DDEV Commands Collection\n"

## Description: Run tabula rasa command inside the web container
## Usage: tr
## Example: "ddev tr"
echo
echo -e "${magenta}[CONFIG]${reset}"
read -p $"Sync database? (y|N) " SYNC_DB

echo -e "${blue}[INFO]${reset} Install composer dependencies"
printf "${reset}${cyan}[DCC]${reset}${reset}<web> ${black}composer install -d ${composerPathApp}${reset}\n"
composer install -d ${composerPathApp}

if [[ $SYNC_DB =~ ^[Yy]$ ]]
then
  echo -e "${blue}[INFO]${reset} Sync database into local database"
  printf "${reset}${cyan}[DCC]${reset}${reset}<web> ${black}db_sync_tool -f ${composerPathDeployment}/deployment/db-sync-tool/sync-${defaultSyncSystem}-to-local.${defaultSyncFileEnding}${reset}\n"
  db_sync_tool -f ${composerPathDeployment}/deployment/db-sync-tool/sync-${defaultSyncSystem}-to-local.${defaultSyncFileEnding}
fi

cd ${composerPathApp}
echo -e "${blue}[INFO]${reset} Database migrations"
printf "${reset}${cyan}[DCC]${reset}${reset}[web] ${black}php bin/console doctrine:migrations:migrate -n${reset}\n"
php bin/console doctrine:migrations:migrate -n
echo -e "${blue}[INFO]${reset} Build assets"
printf "${reset}${cyan}[DCC]${reset}${reset}[web] ${black}npm ci${reset}\n"
npm ci --quiet
printf "${reset}${cyan}[DCC]${reset}${reset}[web] ${black}npm run build${reset}\n"
npm run build --quiet
echo -e "${blue}[INFO]${reset} Clear cache"
printf "${reset}${cyan}[DCC]${reset}${reset}<web> ${black}php ${composerPathApp}/bin/console cache:clear $@${reset}\n"
php ${composerPathApp}/bin/console cache:clear $@

echo
echo -e "${green}Symfony instance successfully resetted${reset}"