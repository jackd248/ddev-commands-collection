#!/bin/bash

############################
# DDEV Commands Collection #
############################

## https://github.com/jackd248/ddev-commands-collection
## v<version/>
## dcc-autogenerated
. "$(dirname "$0")/../dcc-config.sh"
. "$(dirname "$0")/../scripts/dcc-colors.sh"
printf "${reset}${cyan}[DCC]${reset} DDEV Commands Collection\n"

## Description: Install and initialize local TYPO3 instance
## Usage: init
## Example: "ddev init"

echo
echo -e "${magenta}[CONFIG]${reset}"
read -p $"Initialize TYPO3 instanz? (y|N) " INIT_TYPO3
read -p $"Sync database (stage-to-local)? (y|N) " SYNC_DB
read -p $"Build assets? (y|N) " INSTALL_ASSETS

if [[ $INIT_TYPO3 =~ ^[Yy]$ ]]
then
    echo -e "${blue}[INFO]${reset} Install TYPO3 instance"
    cd ${composerPathApp}
    cp .env.ddev.dist .env
    echo -e "${blue}[INFO]${reset} Install dependencies"
    printf "${reset}${cyan}[DCC]${reset}${reset}<web> ${black}composer install${reset}\n"
    composer install

    echo -e "${blue}[INFO]${reset} Setup TYPO3"
    printf "${reset}${cyan}[DCC]${reset}${reset}<web> ${black}php vendor/bin/typo3cms install:setup --no-interaction --skip-integrity-check${reset}\n"
    php vendor/bin/typo3cms install:setup --no-interaction --skip-integrity-check

    echo -e "${green}[OK]${reset} TYPO3 instance installed"
fi

if [[ $SYNC_DB =~ ^[Yy]$ ]]
then
    echo -e "${blue}[INFO]${reset} Sync remote database into local database"
    printf "${reset}${cyan}[DCC]${reset}${reset}<web> ${black}db_sync_tool -f ${composerPathDeployment}/../deployment/db-sync-tool/sync-${defaultSyncSystem}-to-local.${defaultSyncFileEnding}${reset}\n"
    db_sync_tool -f ${composerPathDeployment}/../deployment/db-sync-tool/sync-${defaultSyncSystem}-to-local.${defaultSyncFileEnding}

    ${composerPathApp}/bin/typo3cms database:updateschema
    ${composerPathApp}/bin/typo3cms cache:flush
    # display faq section
    sh "$(dirname "$0")/../faq/dcc-faq-web-sync.sh"
fi


if [[ $INSTALL_ASSETS =~ ^[Yy]$ ]]
then
    echo -e "${blue}[INFO]${reset} Install frontend dependencies"
    cd ${composerPathDeployment}
    printf "${reset}${cyan}[DCC]${reset}${reset}<web> ${black}npm ci${reset}\n"
    npm ci
    echo -e "${blue}[INFO]${reset} Build assets"
    printf "${reset}${cyan}[DCC]${reset}${reset}<web> ${black}npm run build${reset}\n"
    npm run build
    echo -e "${green}[OK]${reset} Assets installed"
fi
echo
echo -e "${green}TYPO3 instance successfully initialized${reset}"
